const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/persistentAssistantService-1dAMUpe6.js","assets/index-e3V0CD7Y.js","assets/index-CVSl0yP1.css"])))=>i.map(i=>d[i]);
import{cQ as c,du as d}from"./index-e3V0CD7Y.js";import{c as p}from"./cache.service-D8Mcd249.js";import{h as m}from"./http-client.service-dRaZJNDp.js";class l{constructor(){this.requestQueue=[],this.processing=!1,this.providers=new Map,this.requestHistory=[],this.initializeProviders().catch(e=>{console.warn("Failed to initialize AI providers:",e)}),this.startQueueProcessor()}async initializeProviders(){try{const e=await fetch("/api/openai/status"),t=e.ok&&(await e.json()).configured===!0}catch(e){console.warn("Failed to check OpenAI availability:",e)}this.providers.set("openai",{name:"openai",available:!0,rateLimit:{remaining:50,resetTime:Date.now()+6e4},performance:{avgResponseTime:2e3,successRate:.95,costPer1kTokens:.002}}),this.providers.set("gemini",{name:"gemini",available:!0,rateLimit:{remaining:60,resetTime:Date.now()+6e4},performance:{avgResponseTime:1500,successRate:.92,costPer1kTokens:5e-4}})}startQueueProcessor(){setInterval(()=>{!this.processing&&this.requestQueue.length>0&&this.processNextRequest()},100)}async processNextRequest(){if(this.requestQueue.length===0)return;this.processing=!0;const e=this.requestQueue.shift();try{const t=await this.executeRequest(e);c.info("AI request completed successfully",{requestId:e.id,type:e.type,processingTime:t.metadata.processingTime})}catch(t){const i=t instanceof Error?t.message:"Unknown error";c.error("AI request failed",t,{requestId:e.id,type:e.type}),i.includes("No AI providers available")&&console.warn("⚠️ Skipping AI request due to no providers:",e.type)}finally{this.processing=!1}}async executeRequest(e){const t=Date.now(),i=this.getCacheKey(e);if(e.options?.useCache!==!1){const n=p.get("ai_responses",i);if(n)return c.debug("AI response served from cache",{requestId:e.id}),{...n,metadata:{...n.metadata,cached:!0}}}const s=await this.selectProvider(e);let a,r;try{const n=await this.callProvider(s,e);a=n.result,r={provider:s.name,model:n.model||"default",processingTime:Date.now()-t,confidence:n.confidence||85,cached:!1,timestamp:new Date().toISOString(),cost:n.cost}}catch(n){throw new Error(`AI provider ${s.name} failed: ${n}`)}const o={id:e.id,type:e.type,result:a,metadata:r};if(e.options?.useCache!==!1){const n=this.getCacheTTL(e.type);p.set("ai_responses",i,o,n,["ai",e.type])}return this.updateProviderPerformance(s.name,r),this.requestHistory.push(o),this.requestHistory.length>1e3&&(this.requestHistory=this.requestHistory.slice(-1e3)),o}async selectProvider(e){const t=Array.from(this.providers.values()).filter(s=>s.available&&s.rateLimit.remaining>0);if(t.length===0)throw console.warn("⚠️ No AI providers available, skipping request:",e.type),new Error("No AI providers available");if(e.options?.provider==="auto"||!e.options?.provider)return this.selectOptimalProvider(e,t);const i=t.find(s=>s.name===e.options?.provider);return i||this.selectOptimalProvider(e,t)}selectOptimalProvider(e,t){return t.map(s=>{let a=0;switch(a+=s.performance.successRate*40,a+=(3e3-s.performance.avgResponseTime)/100,e.priority==="low"&&(a+=(.01-s.performance.costPer1kTokens)*1e3),e.type){case"contact_scoring":case"insights_generation":s.name==="openai"&&(a+=10);break;case"email_generation":case"communication_analysis":break;case"contact_enrichment":case"predictive_analytics":s.name==="openai"&&(a+=5);break;case"automation_suggestions":s.name==="gemini"&&(a+=5);break}return e.priority==="urgent"&&(a+=(3e3-s.performance.avgResponseTime)/50),{provider:s,score:a}}).sort((s,a)=>a.score-s.score)[0].provider}async callProvider(e,t){const i="https://gadedbrnqzpfqtsdfzcg.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhZGVkYnJucXpwZnF0c2RmemNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NjYxMTUsImV4cCI6MjA1ODE0MjExNX0.bpsk8yRpwQQnYaY4qY3hsW5ExrQe_8JA3UZ51mlQ1e4";if(t.context?.assistantThreadId||t.options?.usePersistentThread)return this.callAssistantThread(e,t);if(["contact_scoring","contact_enrichment","insights_generation","predictive_analytics"].includes(t.type)&&t.context?.entityId)return this.callPersistentAssistant(t);const o={contact_scoring:"smart-score",contact_enrichment:"smart-enrichment",email_generation:"email-composer",email_analysis:"email-analyzer",insights_generation:"ai-insights",communication_analysis:"communication-logs",automation_suggestions:"smart-categorize",predictive_analytics:"smart-qualify",relationship_mapping:"smart-enrichment"}[t.type];if(!o)throw new Error(`No endpoint mapping for request type: ${t.type}`);return(await m.post(`${i}/functions/v1/${o}`,{...t.data,aiProvider:e.name,options:t.options},{headers:{Authorization:`Bearer ${s}`},timeout:t.options?.timeout||3e4})).data}async callPersistentAssistant(e){const{persistentAssistantService:t}=await d(async()=>{const{persistentAssistantService:r}=await import("./persistentAssistantService-1dAMUpe6.js");return{persistentAssistantService:r}},__vite__mapDeps([0,1,2]));await t.initialize();const s={contact_scoring:"contact",contact_enrichment:"contact",insights_generation:"deal",predictive_analytics:"pipeline"}[e.type]||"contact",a=e.context?.entityId||"default";try{const r=await t.chatWithPersistentAssistant(s,a,JSON.stringify(e.data),e.context);return{result:r.response,model:"gpt-4o-assistant-persistent",confidence:95,cost:.003,threadId:r.threadId,assistantId:r.assistantId,persistentMemory:r.persistentMemory}}catch(r){throw console.error("Persistent assistant call failed:",r),r}}async callAssistantThread(e,t){return(await m.post("https://gadedbrnqzpfqtsdfzcg.supabase.co/functions/v1/assistant-thread",{...t.data,threadId:t.context?.assistantThreadId,aiProvider:e.name,options:t.options},{headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhZGVkYnJucXpwZnF0c2RmemNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NjYxMTUsImV4cCI6MjA1ODE0MjExNX0.bpsk8yRpwQQnYaY4qY3hsW5ExrQe_8JA3UZ51mlQ1e4"},timeout:t.options?.timeout||3e4})).data}updateProviderPerformance(e,t){const i=this.providers.get(e);if(!i)return;const s=.1;i.performance.avgResponseTime=i.performance.avgResponseTime*(1-s)+t.processingTime*s,i.rateLimit.remaining=Math.max(0,i.rateLimit.remaining-1),Date.now()>i.rateLimit.resetTime&&(i.rateLimit.remaining=i.name==="openai"?50:60,i.rateLimit.resetTime=Date.now()+6e4)}getCacheKey(e){return`${e.type}_${JSON.stringify(e.data)}_${e.options?.provider||"auto"}`}getCacheTTL(e){return{contact_scoring:36e5,contact_enrichment:864e5,email_generation:18e5,email_analysis:18e5,insights_generation:36e5,communication_analysis:18e5,automation_suggestions:72e5,predictive_analytics:36e5,relationship_mapping:864e5}[e]||18e5}async submitRequest(e){const t={...e,id:`ai_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,options:{useCache:!0,provider:"auto",timeout:3e4,...e.options}};return this.requestQueue.push(t),this.requestQueue.sort((i,s)=>{const a={urgent:4,high:3,medium:2,low:1};return a[s.priority]-a[i.priority]}),c.info("AI request queued",{requestId:t.id,type:t.type,priority:t.priority}),t.id}async executeImmediate(e){const t={...e,id:`ai_immediate_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,options:{useCache:!0,provider:"auto",timeout:3e4,...e.options}};return this.executeRequest(t)}getProviderStatus(){return Array.from(this.providers.values())}getRequestHistory(e=50){return this.requestHistory.slice(-e)}getPerformanceMetrics(){const e=this.requestHistory.slice(-100);return{totalRequests:this.requestHistory.length,successRate:e.filter(t=>!t.error).length/e.length,avgResponseTime:e.reduce((t,i)=>t+i.metadata.processingTime,0)/e.length,cacheHitRate:e.filter(t=>t.metadata.cached).length/e.length,providerBreakdown:this.getProviderBreakdown(e)}}getProviderBreakdown(e){const t={};return e.forEach(i=>{t[i.metadata.provider]=(t[i.metadata.provider]||0)+1}),t}clearCache(){c.info("AI cache clear requested")}}const f=new l;export{f as aiOrchestrator};
