import{c as r}from"./cache.service-D8Mcd249.js";import{cQ as i}from"./index-e3V0CD7Y.js";import{v as g}from"./validation.service-DurMElEb.js";class f{constructor(){this.isBackendAvailable=!0,this.isMockMode=!1,this.supabaseUrl="https://gadedbrnqzpfqtsdfzcg.supabase.co",this.supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhZGVkYnJucXpwZnF0c2RmemNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI1NjYxMTUsImV4cCI6MjA1ODE0MjExNX0.bpsk8yRpwQQnYaY4qY3hsW5ExrQe_8JA3UZ51mlQ1e4",this.baseURL=`${this.supabaseUrl}/functions/v1/contacts`,!this.supabaseUrl||!this.supabaseKey?(this.isMockMode=!0,console.warn("Supabase not configured - falling back to local storage")):(this.isMockMode=!1,this.isBackendAvailable=!0,console.log("Using Supabase Edge Functions for contact management (required by remote apps)"))}getSupabaseHeaders(){return{"Content-Type":"application/json",Authorization:`Bearer ${this.supabaseKey}`}}shouldUseFallback(){return this.isMockMode||!this.supabaseUrl||!this.supabaseKey}initializeLocalStorage(){try{const e=localStorage.getItem("contacts");if(e)return JSON.parse(e)}catch{}const s=[{id:"1",firstName:"Jane",lastName:"Doe",name:"Jane Doe",email:"jane.doe@example.com",phone:"+1 (555) 123-4567",title:"Marketing Director",company:"Acme Corp",industry:"Technology",avatarSrc:"",sources:["Website"],interestLevel:"high",status:"prospect",lastConnected:"2024-01-15",aiScore:85,tags:["enterprise","decision-maker"],createdAt:"2024-01-10T10:00:00Z",updatedAt:"2024-01-20T15:30:00Z"}];return localStorage.setItem("contacts",JSON.stringify(s)),s}getLocalContacts(){try{const s=localStorage.getItem("contacts");return s?JSON.parse(s):this.initializeLocalStorage()}catch{return this.initializeLocalStorage()}}saveLocalContacts(s){try{localStorage.setItem("contacts",JSON.stringify(s))}catch{console.warn("Failed to save contacts to localStorage")}}async createContact(s){const e=g.sanitizeContact(s);if(this.shouldUseFallback()){i.info("Using local storage for contact creation");const n=this.getLocalContacts(),o={id:crypto.randomUUID(),firstName:e.firstName||"",lastName:e.lastName||"",name:`${e.firstName||""} ${e.lastName||""}`.trim(),email:e.email||"",phone:e.phone||"",title:e.title||"",company:e.company||"",industry:e.industry||"",avatarSrc:e.avatarSrc||"",sources:e.sources||["Website"],interestLevel:e.interestLevel||"medium",status:e.status||"lead",lastConnected:e.lastConnected,aiScore:e.aiScore,tags:e.tags||[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return n.push(o),this.saveLocalContacts(n),r.set("contact",o.id,o,300,["contact"]),o}try{i.info("Creating contact via Supabase Edge Function");const n={firstName:e.firstName,lastName:e.lastName,email:e.email,phone:e.phone,company:e.company,title:e.title,status:e.status,sources:e.sources||["Website"],aiScore:e.aiScore||null,tags:e.tags||[]},o=await fetch(this.baseURL,{method:"POST",headers:this.getSupabaseHeaders(),body:JSON.stringify(n)});if(!o.ok)throw new Error(`Edge Function error: ${o.status} ${o.statusText}`);const a=await o.json();let t;if(a.contact)t=a.contact;else if(a.data)t=a.data;else if(a.id)t=a;else throw new Error("Unexpected Edge Function response format");const c={id:t.id||crypto.randomUUID(),firstName:t.firstName||t.first_name||"",lastName:t.lastName||t.last_name||"",name:`${t.firstName||t.first_name||""} ${t.lastName||t.last_name||""}`.trim(),email:t.email||"",phone:t.phone||"",title:t.title||t.position||"",company:t.company||"",industry:t.industry||"",avatarSrc:t.avatarSrc||"",sources:t.sources||[t.source||"Website"].filter(Boolean),interestLevel:t.interestLevel||"medium",status:t.status||"lead",lastConnected:t.lastConnected||t.last_contacted,aiScore:t.aiScore||t.ai_score||t.lead_score,tags:t.tags||[],createdAt:t.createdAt||t.created_at||new Date().toISOString(),updatedAt:t.updatedAt||t.updated_at||new Date().toISOString()};return r.set("contact",c.id,c,300,["contact"]),i.info("Contact created successfully via Edge Function",{contactId:c.id}),c}catch(n){i.error("Edge Function unavailable, using localStorage fallback for remote app compatibility",n);const o=this.getLocalContacts(),a={id:crypto.randomUUID(),firstName:e.firstName||"",lastName:e.lastName||"",name:`${e.firstName||""} ${e.lastName||""}`.trim(),email:e.email||"",phone:e.phone||"",title:e.title||"",company:e.company||"",industry:e.industry||"",avatarSrc:e.avatarSrc||"",sources:e.sources||["Website"],interestLevel:e.interestLevel||"medium",status:e.status||"lead",lastConnected:e.lastConnected,aiScore:e.aiScore,tags:e.tags||[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return o.push(a),this.saveLocalContacts(o),r.set("contact",a.id,a,300,["contact"]),i.info("Contact created via localStorage fallback (Edge Function compatibility maintained)"),a}}async getContact(s){const e=r.get("contact",s);if(e)return e;if(this.shouldUseFallback()){i.info("Using local storage for contact retrieval");const o=this.getLocalContacts().find(a=>a.id===s);if(!o)throw new Error(`Contact with ID ${s} not found`);return r.set("contact",s,o,300,["contact"]),o}try{const n=await fetch(`${this.baseURL}/${s}`,{method:"GET",headers:this.getSupabaseHeaders()});if(!n.ok)throw new Error(`Edge Function error: ${n.status} ${n.statusText}`);const o=await n.json(),a=o.contact||o.data||o;if(!a)throw new Error(`Contact with ID ${s} not found`);const t={id:a.id,firstName:a.firstName||a.first_name||"",lastName:a.lastName||a.last_name||"",name:`${a.firstName||a.first_name||""} ${a.lastName||a.last_name||""}`.trim(),email:a.email||"",phone:a.phone||"",title:a.title||a.position||"",company:a.company||"",industry:a.industry||"",avatarSrc:a.avatarSrc||"",sources:a.sources||[a.source||"Website"].filter(Boolean),interestLevel:a.interestLevel||"medium",status:a.status||"lead",lastConnected:a.lastConnected||a.last_contacted,aiScore:a.aiScore||a.ai_score||a.lead_score,tags:a.tags||[],createdAt:a.createdAt||a.created_at,updatedAt:a.updatedAt||a.updated_at};return r.set("contact",s,t,300,["contact"]),t}catch(n){i.error("Edge Function unavailable, using localStorage fallback",n);const a=this.getLocalContacts().find(t=>t.id===s);if(!a)throw new Error(`Contact with ID ${s} not found`);return r.set("contact",s,a,300,["contact"]),a}}async updateContact(s,e){if(Object.keys(e).length===0)throw new Error("No updates provided");const n=g.sanitizeContact(e);if(this.shouldUseFallback()){i.info("Using local storage for contact update");const o=this.getLocalContacts(),a=o.findIndex(c=>c.id===s);if(a===-1)throw new Error(`Contact with ID ${s} not found`);const t={...o[a],...n,updatedAt:new Date().toISOString()};return o[a]=t,this.saveLocalContacts(o),r.set("contact",s,t,300,["contact"]),r.set("contactList","invalidate",null,0,["list"]),t}try{const o=await fetch(`${this.baseURL}/${s}`,{method:"PATCH",headers:this.getSupabaseHeaders(),body:JSON.stringify(n)});if(!o.ok)throw new Error(`Edge Function error: ${o.status} ${o.statusText}`);const a=await o.json(),t=a.contact||a.data||a;if(!t)throw new Error(`Contact with ID ${s} not found`);const c={id:t.id,firstName:t.firstName||t.first_name||"",lastName:t.lastName||t.last_name||"",name:`${t.firstName||t.first_name||""} ${t.lastName||t.last_name||""}`.trim(),email:t.email||"",phone:t.phone||"",title:t.title||t.position||"",company:t.company||"",industry:t.industry||"",avatarSrc:t.avatarSrc||"",sources:t.sources||[t.source||"Website"].filter(Boolean),interestLevel:t.interestLevel||"medium",status:t.status||"lead",lastConnected:t.lastConnected||t.last_contacted,aiScore:t.aiScore||t.ai_score||t.lead_score,tags:t.tags||[],createdAt:t.createdAt||t.created_at,updatedAt:t.updatedAt||t.updated_at||new Date().toISOString()};return r.set("contact",s,c,300,["contact"]),r.set("contactList","invalidate",null,0,["list"]),c}catch(o){i.error("Edge Function unavailable, using localStorage fallback",o);const a=this.getLocalContacts(),t=a.findIndex(d=>d.id===s);if(t===-1)throw new Error(`Contact with ID ${s} not found`);const c={...a[t],...n,updatedAt:new Date().toISOString()};return a[t]=c,this.saveLocalContacts(a),r.set("contact",s,c,300,["contact"]),r.set("contactList","invalidate",null,0,["list"]),c}}async deleteContact(s){if(this.shouldUseFallback()){i.info("Using local storage for contact deletion");const e=this.getLocalContacts(),n=e.filter(o=>o.id!==s);if(n.length===e.length)throw new Error(`Contact with ID ${s} not found`);this.saveLocalContacts(n),r.set("contactDelete",s,null,0,["contact"]);return}try{const e=await fetch(`${this.baseURL}/${s}`,{method:"DELETE",headers:this.getSupabaseHeaders()});if(!e.ok)throw new Error(`Edge Function error: ${e.status} ${e.statusText}`);r.set("contactDelete",s,null,0,["contact"]),r.set("contactList","invalidate",null,0,["list"]),i.info("Contact deleted successfully via Edge Function",{contactId:s})}catch(e){i.error("Edge Function unavailable, using localStorage fallback",e);const n=this.getLocalContacts(),o=n.filter(a=>a.id!==s);if(o.length===n.length)throw new Error(`Contact with ID ${s} not found`);this.saveLocalContacts(o),r.set("contactDelete",s,null,0,["contact"])}}async getContacts(s={}){const e=JSON.stringify(s),n=r.get("contactList",e);if(n)return n;let o=this.getLocalContacts();if(s.search){const l=s.search.toLowerCase();o=o.filter(u=>u.name.toLowerCase().includes(l)||u.email.toLowerCase().includes(l)||u.company.toLowerCase().includes(l))}s.status&&s.status!=="all"&&(o=o.filter(l=>l.status===s.status)),s.tags&&s.tags.length>0&&(o=o.filter(l=>s.tags.some(u=>l.tags.includes(u)))),s.hasAIScore!==void 0&&(o=o.filter(l=>s.hasAIScore?!!l.aiScore:!l.aiScore)),s.sortBy&&o.sort((l,u)=>{const h=l[s.sortBy],m=u[s.sortBy];return h<m?s.sortOrder==="asc"?-1:1:h>m?s.sortOrder==="asc"?1:-1:0});const a=s.limit||50,t=s.offset||0,c=o.slice(t,t+a),d={contacts:c,total:o.length,limit:a,offset:t,hasMore:t+c.length<o.length};return r.set("contactList",e,d,300,["list"]),d}async getContactStats(){const s=r.get("contactStats","all");if(s)return s;const e=this.getLocalContacts(),n={total:e.length,byStatus:{},byTags:{},withAIScore:0,avgAIScore:0,recentlyUpdated:0};let o=0,a=0;const t=new Date(Date.now()-10080*60*1e3);return e.forEach(c=>{n.byStatus[c.status]=(n.byStatus[c.status]||0)+1,c.tags.forEach(d=>{n.byTags[d]=(n.byTags[d]||0)+1}),c.aiScore&&(n.withAIScore++,o+=c.aiScore,a++),new Date(c.updatedAt)>t&&n.recentlyUpdated++}),n.avgAIScore=a>0?o/a:0,r.set("contactStats","all",n,300,["stats"]),n}async enrichContact(s){const e=await this.getContact(s);return i.info("Contact enrichment not implemented yet"),e}async scoreContact(s){const e=await this.getContact(s);return i.info("Contact scoring not implemented yet"),e}}const w=new f;export{w as contactAPIService,w as default};
